---
// When Astro persists an element using transition:persist, it moves the actual DOM element to the new page.

// Scoped CSS problem: The persisted element retains its original data-astro-cid-XXXX attribute from the old page component.
// Style Mismatch: The new page loads CSS with a different hash scope (e.g., data-astro-cid-YYYY). Since the persisted element still has the old hash, the new page's scoped styles (which target [data-astro-cid-YYYY]) fail to apply to it.
// The Fix: Global Scoping
// I created a new component VideoPlayer.astro that uses <style is:global>.

// Instead of relying on Astro's class hashing, I targeted the element using its stable persist ID:
// This ensures that no matter which page you are on (Index or Detail), the CSS selector remains valid because it targets the transition properties rather than component scope hashes.

interface Props {
  src: string;
  playerTitle?: string;
}

const { playerTitle, src } = Astro.props;
---

<div class="persistent-player-wrapper">
  <div
    class="persistent-player"
    transition:persist="video-player"
  >
    <div class="player-header">
      <span class="recording-dot"></span>
      {playerTitle ? <span>{playerTitle}</span> : null}
    </div>
    <video
      controls
      autoplay
      loop
      muted
      src={src}
      class="bridge-cam"
    ></video>
  </div>
</div>

<style is:global>
  /* Global Persistent Player Styles */
  .persistent-player-wrapper {
    margin-bottom: 2rem;
  }

  /* 
    IMPORTANT: We use a global selector targeting the persist id 
    to ensure styles apply consistently across Astro's view transitions
    even when scope hashes change.
  */
  div[data-astro-transition-persist='video-player'] {
    background: #000;
    border: 1px solid #333;
    border-radius: 8px;
    padding: 0.5rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    /* Default Max Width (can be overridden by specific page contexts if specificity is higher or via layout classes) */
    max-width: 500px;
    margin-inline: auto;
  }

  .player-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #4ade80;
    font-size: 0.8rem;
    margin-bottom: 0.5rem;
    font-family: monospace;
    text-transform: uppercase;
  }

  .recording-dot {
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    animation: pulse 1s infinite;
  }

  .bridge-cam {
    display: block;
    width: 100%;
    aspect-ratio: 16 / 9;
    background: #111;
    border-radius: 4px;
    object-fit: cover;
  }

  /* Context-specific overrides need to be handled carefully with global CSS or specific parents */

  @keyframes pulse {
    0% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
    100% {
      opacity: 1;
    }
  }
</style>
